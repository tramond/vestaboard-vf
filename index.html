<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Vestaboard Sonos</title>

<style>
  body {
    margin: 0;
    background: #111;
    height: 100vh;
    display: flex;
    justify-content: center;
    align-items: center;
    font-family: monospace;
    color: #f5f5f5;
  }

  #board {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 10px;
    width: 90vw;
    max-width: 800px;
    text-align: center;
    font-size: 28px;
    letter-spacing: 2px;
  }

  .row {
    min-height: 34px;
    white-space: nowrap;
  }
</style>
</head>

<body>
  <div id="board"></div>

<script>
/* ================= CONFIG ================= */

const SONOS_URL = "http://192.168.86.26:5005/zones";

const CUSTOM_MESSAGES = [
  "WELCOME HOME",
  "GOOD VIBES ONLY",
  "NOW PLAYING ON SONOS",
  "ENJOY THE MUSIC",
  "MERRY CHRISTMAS BABY",
  "MERRY CRIMMUH NIKKUH - FROM PINKY NIKKUH",
  "HEY RIVER!",
  "HEY KENDALL!",
];

/* - - - - CHANGE ROTATE FREQUENCY - - - - */
const ROTATE_INTERVAL = 05000;
const MAX_CHARS_PER_LINE = 22;

/* ================= STATE ================= */

let showNowPlaying = true;
let customIndex = 0;

/* ================= UTIL ================= */

function wrapText(text) {
  const words = text.split(" ");
  const lines = [];
  let line = "";

  for (const word of words) {
    if ((line + word).length <= MAX_CHARS_PER_LINE) {
      line += (line ? " " : "") + word;
    } else {
      lines.push(line);
      line = word;
    }
  }
  if (line) lines.push(line);
  return lines;
}

function shuffleReveal(text, el) {
  const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
  let i = 0;

  const interval = setInterval(() => {
    el.textContent = text
      .split("")
      .map((c, idx) => (idx < i ? c : chars[Math.floor(Math.random() * chars.length)]))
      .join("");
    i++;
    if (i > text.length) clearInterval(interval);
  }, 35);
}

function display(lines) {
  const board = document.getElementById("board");
  board.innerHTML = "";

  lines.forEach(line => {
    const row = document.createElement("div");
    row.className = "row";
    board.appendChild(row);
    shuffleReveal(line.toUpperCase(), row);
  });
}

/* ================= SONOS ================= */

async function getNowPlaying() {
  try {
    const res = await fetch(SONOS_URL);
    const zones = await res.json();

    if (!Array.isArray(zones) || zones.length === 0) return null;

    // Use the coordinator (this is always the authoritative player)
    const zone = zones[0];
    const state = zone.coordinator?.state;

    if (
      !state ||
      state.playbackState !== "PLAYING" ||
      !state.currentTrack
    ) {
      return null;
    }

    return {
      artist: state.currentTrack.artist || "",
      title: state.currentTrack.title || ""
    };
  } catch (e) {
    console.error("Sonos error:", e);
    return null;
  }
}


/* ================= ROTATION ================= */

async function rotate() {
  if (showNowPlaying) {
    const data = await getNowPlaying();

    if (data) {
      const artistLines = wrapText(data.artist);
      const titleLines = wrapText(data.title);

      display([
        "NOW PLAYING",
        ...artistLines,
        ...titleLines
      ]);
    } else {
      display(["SONOS NOT PLAYING"]);
    }
  } else {
    display(wrapText(CUSTOM_MESSAGES[customIndex]));
    customIndex = (customIndex + 1) % CUSTOM_MESSAGES.length;
  }

  showNowPlaying = !showNowPlaying;
}

display(["LOADING"]);
rotate();
setInterval(rotate, ROTATE_INTERVAL);
</script>
</body>
</html>
