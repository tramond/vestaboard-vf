<script>
const SONOS_URL = "http://YOUR_MAC_IP:5005/zones";

const CUSTOM_MESSAGES = [
  "WELCOME HOME",
  "NOW PLAYING ON SONOS",
  "GOOD VIBES ONLY",
  "ENJOY THE MUSIC"
  "MERRY CHRISTMAS NIKKUH - FROM PINKY NIKKUH"
  "TURN IT UP"
  "THE BAISDEN FAMILY HOME"
  "WE WISH YOU A MERRY CHRISTMAS"
  "HEY KENDALL!"
  "HEY RIVER!"
];

const DISPLAY_INTERVAL = 45000; // 45 seconds
const MAX_LINE_LENGTH = 22;

let customIndex = 0;
let showNowPlaying = true;

// ---------------- SONOS ----------------

async function getNowPlaying() {
  try {
    const res = await fetch(SONOS_URL);
    const zones = await res.json();

    const playingZone = zones.find(z => z.state === "playing");
    if (!playingZone) return null;

    return {
      artist: playingZone.artist || "",
      title: playingZone.title || ""
    };
  } catch (e) {
    console.error("Sonos error", e);
    return null;
  }
}

// ---------------- DISPLAY ----------------

function splitText(text) {
  if (text.length <= MAX_LINE_LENGTH) return [text];
  const mid = Math.ceil(text.length / 2);
  return [text.slice(0, mid), text.slice(mid)];
}

function shuffleText(text, element) {
  const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
  let iterations = 0;

  const interval = setInterval(() => {
    element.textContent = text
      .split("")
      .map((char, i) =>
        i < iterations ? char : chars[Math.floor(Math.random() * chars.length)]
      )
      .join("");

    iterations += 1;
    if (iterations >= text.length) clearInterval(interval);
  }, 40);
}

function displayLines(lines) {
  const board = document.getElementById("board");
  board.innerHTML = "";

  lines.forEach(line => {
    const row = document.createElement("div");
    row.className = "row";
    board.appendChild(row);
    shuffleText(line.toUpperCase(), row);
  });
}

// ---------------- ROTATION ----------------

async function rotate() {
  if (showNowPlaying) {
    const data = await getNowPlaying();
    if (data) {
      const artistLines = splitText(data.artist);
      const titleLines = splitText(data.title);

      displayLines([
        "NOW PLAYING:",
        ...artistLines,
        ...titleLines
      ]);
    }
  } else {
    displayLines([CUSTOM_MESSAGES[customIndex]]);
    customIndex = (customIndex + 1) % CUSTOM_MESSAGES.length;
  }

  showNowPlaying = !showNowPlaying;
}

rotate();
setInterval(rotate, DISPLAY_INTERVAL);
</script>
